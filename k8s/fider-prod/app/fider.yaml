---
apiVersion: v1
kind: Namespace
metadata:
  name: fider-prod
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: fider-sa
  namespace: fider-prod
  annotations:
    azure.workload.identity/client-id: "9b138bb9-7f52-4a0b-bef0-7786d4f9ef6b"
  labels:
    azure.workload.identity/use: "true"
---
# ðŸ”‘ SecretProviderClass dans le mÃªme namespace, avec crÃ©ation du Secret K8s
apiVersion: secrets-store.csi.x-k8s.io/v1
kind: SecretProviderClass
metadata:
  name: azure-kv-fider
  namespace: fider-prod
spec:
  provider: azure
  parameters:
    tenantId: "c87cdf06-bc04-4c92-9a1e-7e1cab14c979"     # <-- ton tenant
    keyvaultName: "keyvault-fider"                        # <-- ton Key Vault
    clientID: "9b138bb9-7f52-4a0b-bef0-7786d4f9ef6b"      # <-- App Registration (client ID)
    objects: |
      array:
        - |
          objectName: fider-jwt-secret
          objectType: secret
        - |
          objectName: fider-smtp-username
          objectType: secret
        - |
          objectName: fider-smtp-password
          objectType: secret
  secretObjects:
    - secretName: fider-secrets
      type: Opaque
      data:
        - key: JWT_SECRET
          objectName: fider-jwt-secret
        - key: EMAIL_SMTP_USERNAME
          objectName: fider-smtp-username
        - key: EMAIL_SMTP_PASSWORD
          objectName: fider-smtp-password
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: fider-app
  namespace: fider-prod
spec:
  replicas: 2
  selector:
    matchLabels:
      app: fider-app
  template:
    metadata:
      labels:
        app: fider-app
    spec:
      serviceAccountName: fider-sa
      volumes:
        - name: kv
          csi:
            driver: secrets-store.csi.k8s.io
            readOnly: true
            volumeAttributes:
              secretProviderClass: "azure-kv-fider"
      containers:
        - name: fider
          image: getfider/fider:stable
          volumeMounts:
            - name: kv
              mountPath: /mnt/secrets-store
              readOnly: true
          env:
            - name: JWT_SECRET
              valueFrom: { secretKeyRef: { name: fider-secrets, key: JWT_SECRET } }
            - name: EMAIL_SMTP_USERNAME
              valueFrom: { secretKeyRef: { name: fider-secrets, key: EMAIL_SMTP_USERNAME } }
            - name: EMAIL_SMTP_PASSWORD
              valueFrom: { secretKeyRef: { name: fider-secrets, key: EMAIL_SMTP_PASSWORD } }
            - name: DATABASE_URL
              value: "postgres://OctavePostgresUser1234:AFBBdjfjhghfh1277432!@postgres:5432/fiderdb?sslmode=disable"
            - name: BASE_URL
              value: "https://feedback.keyos.fr"
            - name: EMAIL_NOREPLY
              value: "noreply.feedback@keyos.fr"
            - name: EMAIL_SMTP_HOST
              value: "smtp.gmail.com"
            - name: EMAIL_SMTP_PORT
              value: "587"
            - name: EMAIL_SMTP_ENABLE_STARTTLS
              value: "true"
          ports:
            - containerPort: 3000
          readinessProbe:
            httpGet: { path: "/", port: 3000 }
            initialDelaySeconds: 5
            periodSeconds: 5
            failureThreshold: 12
          livenessProbe:
            tcpSocket: { port: 3000 }
            initialDelaySeconds: 60
            periodSeconds: 10
            failureThreshold: 6
---
apiVersion: v1
kind: Service
metadata:
  name: fider-app
  namespace: fider-prod
spec:
  selector:
    app: fider-app
  ports:
    - name: http
      port: 80
      targetPort: 3000
  type: ClusterIP
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: fider
  namespace: fider-prod
  annotations:
    cert-manager.io/cluster-issuer: letsencrypt
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
    nginx.ingress.kubernetes.io/proxy-body-size: "10m"   # optionnel (uploads)
spec:
  ingressClassName: nginx
  tls:
    - hosts:
        - feedback.keyos.fr
      secretName: fider-tls
  rules:
    - host: feedback.keyos.fr
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: fider-app
                port:
                  number: 80
---
apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
    name: letsencrypt
spec:
    acme:
        email: thomas.deoliveira2024@campus-eni.fr
        server: https://acme-v02.api.letsencrypt.org/directory
        privateKeySecretRef:
            name: letsencrypt-account-key
        solvers:
            - http01:
                  ingress:
                      class: nginx
